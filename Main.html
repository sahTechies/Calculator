<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Scientific Calculator (Functional)</title>
  <style>
    :root{ --bg:#0e0f13; --panel:#1a1c21; --lcd:#d9efe2; --lcd-text:#0b1b12; --ink:#e8e9ee; --muted:#9aa0ac; --accent:#f59e0b; --alpha:#a78bfa; --mode:#6b7280; --op:#fbbf24; --enter:#f59e66; --danger:#ef4444; --key:#24262e; --key-2:#2a2d36; --ring:#2f3340;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 15% 10%, #171922 0%, #0f1117 50%, #0b0c10 100%);color:var(--ink);font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;display:grid;place-items:center;padding:16px}
    .calc{width:min(420px,94vw);background:linear-gradient(180deg,#111318,#0e1016);border:1px solid var(--ring);border-radius:20px;box-shadow:0 18px 40px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.03);overflow:hidden}
    .head{padding:10px 12px 8px 12px;display:flex;align-items:center;gap:8px;justify-content:space-between;background:linear-gradient(180deg,#0f1218,#0c0e13);border-bottom:1px solid var(--ring)}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:10px;line-height:1;letter-spacing:.2px;padding:5px 7px;border-radius:6px;color:#0f1117;font-weight:700;background:#cbd5e1}
    .lcd{margin:10px 12px;background:var(--lcd);color:var(--lcd-text);border-radius:12px;border:1px solid #b7d7c4;box-shadow:inset 0 1px 0 rgba(255,255,255,.6), inset 0 -1px 0 rgba(0,0,0,.05);padding:10px 12px}
    .exp{font-size:14px;min-height:22px;color:#3c5d4f;opacity:.9;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .ans{font-size:28px;font-weight:700;min-height:36px;text-align:right}
    .keys{padding:12px;display:grid;grid-template-columns:repeat(6,1fr);grid-auto-rows:56px;gap:8px;background:linear-gradient(180deg,#0d1016,#0b0d12)}
    button.key{appearance:none;border:1px solid var(--ring);outline:0;background:linear-gradient(180deg,var(--key-2),var(--key));color:var(--ink);border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);transition:transform .02s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease}
    button.key:hover{border-color:#3a4050;background:linear-gradient(180deg,#2d3040,#282c39)}
    button.key:active{transform:translateY(1px)}
    .k-shift{background:linear-gradient(180deg, rgba(245,158,11,.22), rgba(36,38,46,.9));border-color:rgba(245,158,11,.45);color:#ffd089}
    .k-alpha{background:linear-gradient(180deg, rgba(167,139,250,.22), rgba(36,38,46,.9));border-color:rgba(167,139,250,.45);color:#e9ddff}
    .k-mode{background:linear-gradient(180deg, rgba(107,114,128,.25), rgba(36,38,46,.9));border-color:rgba(107,114,128,.5);color:#e5e7eb}
    .k-op{color:#fff3cf;background:linear-gradient(180deg, rgba(251,191,36,.22), rgba(36,38,46,.9));border-color:rgba(251,191,36,.5)}
    .k-enter{background:linear-gradient(180deg, rgba(245,158,102,.28), rgba(36,38,46,.92));border-color:rgba(245,158,102,.6);color:#fff}
    .k-danger{background:linear-gradient(180deg, rgba(239,68,68,.22), rgba(36,38,46,.9));border-color:rgba(239,68,68,.55);color:#ffe9e9}
    .h2{grid-row:span 2;height:calc(56px*2 + 8px)}
    .w2{grid-column:span 2}
    .legend{display:block;font-size:9px;line-height:1;color:var(--muted);font-weight:600;margin-top:2px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <main class="calc" role="application" aria-label="Scientific calculator">
    <header class="head">
      <div class="badges">
        <span class="badge" id="modeAngle">DEG</span>
        <span class="badge">MATH</span>
      </div>
      <div class="badges">
        <span class="badge" id="badgeShift">SHIFT</span>
        <span class="badge" id="badgeAlpha">ALPHA</span>
      </div>
    </header>

    <section class="lcd" aria-live="polite" aria-atomic="true">
      <div class="exp" id="exp">0</div>
      <div class="ans" id="ans">0</div>
    </section>

    <section class="keys" id="keys">
      <!-- Row: modifiers -->
      <button class="key k-shift" data-action="shift">SHIFT</button>
      <button class="key k-alpha" data-action="alpha">ALPHA</button>
      <button class="key" data-action="left">◀</button>
      <button class="key" data-action="right">▶</button>
      <button class="key k-mode" data-action="mode">MODE</button>
      <button class="key" data-action="second">2nd</button>

      <!-- Row: calc/solve set -->
      <button class="key" data-fn="calc">CALC<span class="legend">solve</span></button>
      <button class="key" data-fn="ddx">d/dx</button>
      <button class="key" data-fn="integral">∫</button>
      <button class="key" data-insert="10^">10ˣ</button>
      <button class="key" data-fn="logy">Log,y</button>
      <button class="key" data-fn="fact">x!</button>

      <!-- Row: powers -->
      <button class="key" data-op="^">xʸ</button>
      <button class="key" data-fn="sqrt">√</button>
      <button class="key" data-op="^2">x²</button>
      <button class="key" data-fn="log10">Log</button>
      <button class="key" data-fn="ln">Ln</button>
      <button class="key" data-fn="exp">eˣ</button>

      <!-- Row: trig -->
      <button class="key" data-op="neg">(−)</button>
      <button class="key" data-toggle="hyp">hyp</button>
      <button class="key" data-fn="sin">Sin</button>
      <button class="key" data-fn="cos">Cos</button>
      <button class="key" data-fn="tan">Tan</button>
      <button class="key" data-insert="pi">π</button>

      <!-- Row: memory / operators -->
      <button class="key" data-action="rcl">RCL</button>
      <button class="key" data-fn="eng">ENG</button>
      <button class="key" data-op="%">%</button>
      <button class="key k-op" data-op="÷">÷</button>
      <button class="key k-op" data-op="×">×</button>
      <button class="key k-danger" data-action="clearall">CLR ALL</button>

      <!-- Row: 7 8 9 -->
      <button class="key" data-num="7">7</button>
      <button class="key" data-num="8">8</button>
      <button class="key" data-num="9">9</button>
      <button class="key k-op" data-op="−">−</button>
      <button class="key k-op" data-op="+">+</button>
      <button class="key k-enter h2" data-action="ac">AC</button>

      <!-- Row: 4 5 6 -->
      <button class="key" data-num="4">4</button>
      <button class="key" data-num="5">5</button>
      <button class="key" data-num="6">6</button>
      <button class="key" data-fn="inv">x⁻¹</button>
      <button class="key" data-insert="Exp">Exp</button>

      <!-- Row: 1 2 3 -->
      <button class="key" data-num="1">1</button>
      <button class="key" data-num="2">2</button>
      <button class="key" data-num="3">3</button>
      <button class="key w2" data-action="ans">Ans</button>
      <button class="key k-enter h2" data-action="equals">=</button>

      <!-- Row: 0 . (), , -->
      <button class="key w2" data-num="0">0</button>
      <button class="key" data-num=".">.</button>
      <button class="key" data-insert="()">( )</button>
      <button class="key" data-insert=",">,</button>
    </section>
  </main>

  <script>
    // --- State ---
    const expEl = document.getElementById('exp');
    const ansEl = document.getElementById('ans');
    const angleBadge = document.getElementById('modeAngle');
    let expr = '';
    let cursor = null;           // not shown, but reserved for ◀ ▶
    let ansVal = 0;
    let memVal = 0;
    let angleMode = 'DEG';       // DEG | RAD
    let hypMode = false;         // for sinh/cosh/tanh

    // --- Utilities ---
    const insertAtEnd = (s) => { expr += s; render(); };
    const render = () => { expEl.textContent = expr || '0'; ansEl.textContent = String(ansVal); };
    const deg2rad = v => v * Math.PI / 180;
    const rad2deg = v => v * 180 / Math.PI;

    // Tokenizer: numbers, constants, functions, operators, parentheses, comma
    function tokenize(s){
      const tokens = [];
      const re = /\s*([0-9]*\.?[0-9]+|pi|e|Ans|sin|cos|tan|asin|acos|atan|sinh|cosh|tanh|log|ln|sqrt|exp|ENG|Exp|[()+\-*/^%,]|×|÷|−|!)/gi;
      let m;
      while((m = re.exec(s))!==null){ tokens.push(m[1]); }
      return tokens;
    }

    // To JS operation mapping
    function toRPN(tokens){
      // Shunting-yard
      const out=[], op=[];
      const prec = {'!':5,'^':4,'*':3,'/':3,'×':3,'÷':3,'%':3,'+':2,'-':2,'−':2, ',':1};
      const rightAssoc = {'^':true,'!':true};
      const funcs = new Set(['sin','cos','tan','asin','acos','atan','sinh','cosh','tanh','log','ln','sqrt','exp']);
      let prev = null;

      for(const t of tokens){
        if(/^[0-9]*\.?[0-9]+$/i.test(t) || /^pi|e|Ans$/i.test(t)){
          out.push(t);
        } else if(funcs.has(t)){
          op.push(t);
        } else if(t === ','){
          while(op.length && op[op.length-1] !== '('){ out.push(op.pop()); }
          out.push(','); // marker for argument separation
        } else if(t === '('){
          op.push(t);
        } else if(t === ')'){
          while(op.length && op[op.length-1] !== '('){ out.push(op.pop()); }
          op.pop(); // pop '('
          if(op.length && funcs.has(op[op.length-1])) out.push(op.pop());
        } else {
          // operator; handle unary minus
          let tok = t;
          if((t==='-'||t==='−') && (prev===null || ['+','-','−','*','/','×','÷','^','%','('].includes(prev))){
            // represent unary minus as 'u-'
            tok = 'u-';
          }

          if(tok==='u-'){
            op.push(tok);
          } else {
            // factorial sticks as postfix of previous value
            if(t==='!'){
              out.push('!');
            } else {
              while(op.length){
                const top=op[op.length-1];
                if(top==='('||top==='u-') break;
                const pTop = prec[top] ?? 0;
                const pTok = prec[t] ?? 0;
                if((!rightAssoc[t] && pTok<=pTop) || (rightAssoc[t] && pTok<pTop)){
                  out.push(op.pop());
                } else break;
              }
              op.push(t);
            }
          }
        }
        prev = t;
      }
      while(op.length){ out.push(op.pop()); }
      return out;
    }

    function evalRPN(rpn){
      const st=[];
      const toNum = (v)=>{
        if(typeof v==='number') return v;
        if(/^Ans$/i.test(v)) return ansVal;
        if(/^pi$/i.test(v)) return Math.PI;
        if(/^e$/i.test(v)) return Math.E;
        return parseFloat(v);
      };

      const callTrig = (fn, x)=>{
        const v = angleMode==='DEG' ? deg2rad(x) : x;
        return Math[fn](v);
      };
      const callATrig = (fn, x)=>{
        const v = Math[fn](x);
        return angleMode==='DEG' ? rad2deg(v) : v;
      };

      for(let i=0;i<rpn.length;i++){
        const t = rpn[i];
        if(typeof t==='string' && /^[0-9]*\.?[0-9]+$|^pi$|^e$|^Ans$/i.test(t)){
          st.push(toNum(t));
        } else if(t==='u-'){
          st.push(-st.pop());
        } else if(t==='!'){
          const a = st.pop();
          if(a<0 || !Number.isFinite(a)) return NaN;
          let r=1; for(let k=2;k<=Math.floor(a);k++) r*=k;
          st.push(r);
        } else if(t===',' ){
          // ignore in eval; handled by functions that expect 2 args
          st.push(','); 
        } else if(['+','-','−','*','/','×','÷','^','%'].includes(t)){
          let b=st.pop(), a=st.pop();
          if(t==='^') st.push(a**b);
          else if(t==='*'||t==='×') st.push(a*b);
          else if(t==='/'||t==='÷') st.push(a/b);
          else if(t==='+' ) st.push(a+b);
          else if(t==='-'||t==='−') st.push(a-b);
          else if(t==='%') st.push(a*(b/100));
        } else if(['sin','cos','tan','asin','acos','atan','sinh','cosh','tanh','log','ln','sqrt','exp'].includes(t)){
          if(['sin','cos','tan'].includes(t)){
            const x = st.pop();
            const fn = hypMode ? (t+'h') : t;
            if(fn==='sinh') st.push(Math.sinh(angleMode==='DEG'?deg2rad(x):x));
            else if(fn==='cosh') st.push(Math.cosh(angleMode==='DEG'?deg2rad(x):x));
            else if(fn==='tanh') st.push(Math.tanh(angleMode==='DEG'?deg2rad(x):x));
            else st.push(callTrig(t, x));
          } else if(['asin','acos','atan'].includes(t)){
            const x = st.pop();
            st.push(callATrig(t, x));
          } else if(t==='log'){ st.push(Math.log10(st.pop())); }
          else if(t==='ln'){ st.push(Math.log(st.pop())); }
          else if(t==='sqrt'){ st.push(Math.sqrt(st.pop())); }
          else if(t==='exp'){ st.push(Math.exp(st.pop())); }
        } else {
          // Unknown token
          return NaN;
        }
      }
      return st.length===1 ? st[0] : NaN;
    }

    function evaluateExpression(s){
      // Quick replacements from pretty symbols to tokens
      s = s.replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-');
      s = s.replace(/x⁻¹/g,'(1/x)');
      s = s.replace(/x²/g,'^2').replace(/10\^/g,'10^');
      s = s.replace(/π/g,'pi');

      const tokens = tokenize(s);
      const rpn = toRPN(tokens);
      const val = evalRPN(rpn);
      if(!Number.isFinite(val)) return 'Error';
      // rounding to reduce FP artifacts
      const out = Math.round((val + Number.EPSILON) * 1e12) / 1e12;
      return out.toString();
    }

    // --- Input helpers ---
    function pushNum(n){ expr += n; render(); }
    function pushOp(op){
      if(op==='neg'){ expr += (expr.endsWith('(')||expr===''? '-' : '(-'); if(expr.endsWith('(-')) expr += ''; render(); return; }
      expr += op; render();
    }
    function pushFn(name){
      const map = {
        sqrt:'sqrt(', log10:'log(', ln:'ln(', exp:'exp(',
        sin:'sin(', cos:'cos(', tan:'tan(', inv:'(1/(', fact:'!)'
      };
      if(name==='inv'){ expr += '(1/'; render(); return; }
      if(name==='fact'){ expr += '!'; render(); return; }
      expr += (map[name] || name+'('); render();
    }

    function insertToken(tok){
      if(tok==='()'){ expr += '()'; render(); return; }
      if(tok==='pi'){ expr += 'π'; render(); return; }
      if(tok==='Exp'){ expr += 'Exp'; render(); return; }
      if(tok==='10^'){ expr += '10^'; render(); return; }
      expr += tok; render();
    }

    function doEquals(){
      const res = evaluateExpression(expr.replace(/Ans/g, String(ansVal)));
      ansVal = (res==='Error') ? ansVal : Number(res);
      ansEl.textContent = res;
    }

    // --- Button wiring ---
    document.getElementById('keys').addEventListener('click', (e)=>{
      const b = e.target.closest('button.key');
      if(!b) return;

      const n = b.dataset.num;
      const op = b.dataset.op;
      const fn = b.dataset.fn;
      const act = b.dataset.action;
      const ins = b.dataset.insert;

      if(n!==undefined){ pushNum(n); return; }
      if(op!==undefined){
        if(op==='^2'){ expr += '^2'; render(); return; }
        if(op==='%'){ expr += '%'; render(); return; }
        if(op==='neg'){ pushOp('neg'); return; }
        expr += op; render(); return;
      }
      if(fn!==undefined){
        if(fn==='fact'){ pushFn('fact'); return; }
        if(fn==='inv'){ pushFn('inv'); return; }
        pushFn(fn); return;
      }
      if(ins!==undefined){ insertToken(ins); return; }
      if(act){
        if(act==='equals'){ doEquals(); return; }
        if(act==='ac'){ expr=''; render(); return; }
        if(act==='clearall'){ expr=''; ansVal=0; memVal=0; render(); return; }
        if(act==='ans'){ expr += (expr && /[0-9eπ)]$/.test(expr)) ? '*Ans' : 'Ans'; render(); return; }
        if(act==='rcl'){ expr += (expr && /[0-9eπ)]$/.test(expr)) ? '*'+memVal : String(memVal); render(); return; }
        if(act==='mode'){ angleMode = angleMode==='DEG' ? 'RAD':'DEG'; angleBadge.textContent = angleMode; return; }
        if(act==='shift' || act==='alpha' || act==='second'){ /* visual only in this demo */ return; }
        if(act==='left' || act==='right'){ /* cursor reserved; not shown */ return; }
      }
    });

    // Keyboard: basic digits/operators/Enter
    window.addEventListener('keydown',(e)=>{
      const k=e.key;
      if((k>='0'&&k<='9') || k==='.' ){ pushNum(k); return; }
      if(['+','-','*','/','%','^','(',')'].includes(k)){ insertAtEnd(k); return; }
      if(k==='Enter' || k==='='){ e.preventDefault(); doEquals(); return; }
      if(k==='Backspace'){ expr = expr.slice(0,-1); render(); return; }
      if(k.toLowerCase()==='c'){ expr=''; render(); return; }
    });

    render();
  </script>
</body>
</html>
